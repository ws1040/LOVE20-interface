(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9063],{18449:(e,r,s)=>{"use strict";s.d(r,{X:()=>a});var n=s(76200);class t extends n.C{constructor({value:e}){super(`Number \`${e}\` is not a valid decimal number.`,{name:"InvalidDecimalNumberError"})}}function a(e,r){if(!/^(-?)([0-9]*)\.?([0-9]*)$/.test(e))throw new t({value:e});let[s,n="0"]=e.split("."),a=s.startsWith("-");if(a&&(s=s.slice(1)),n=n.replace(/(0+)$/,""),0===r)1===Math.round(Number(`.${n}`))&&(s=`${BigInt(s)+1n}`),n="";else if(n.length>r){let[e,t,a]=[n.slice(0,r-1),n.slice(r-1,r),n.slice(r)],i=Math.round(Number(`${t}.${a}`));(n=i>9?`${BigInt(e)+BigInt(1)}0`.padStart(e.length+1,"0"):`${e}${i}`).length>r&&(n=n.slice(1),s=`${BigInt(s)+1n}`),n=n.slice(0,r)}else n=n.padEnd(r,"0");return BigInt(`${a?"-":""}${s}${n}`)}},28529:(e,r,s)=>{"use strict";s.r(r),s.d(r,{default:()=>P});var n=s(40854),t=s(37876),a=s(14232),i=s(89099),o=s(62212),l=s(64115),c=s(17660),d=s(20451),u=s(83416),m=s(92101),f=s(60154),x=s(12293),v=s(22605),b=s(16927),h=s(3576),p=s(62701),g=s(4902),N=s(13810),j=s(88992),y=s(22442),I=s(8047),_=s(97685),w=s(6960),C=s(7446),k=s(77932),A=s(40150),S=s(92659),R=s(42038),B=s(20442),E=s(9215),F=s(44769),$=s(1709),M=s(99574);let J=e=>{var r,s=e.actionInfo,o=e.stakedAmount,l=(0,i.useRouter)(),m=((0,a.useContext)(u.N)||{}).token,f=(0,I.F)(),v=f.address,J=f.chain,P=(0,E.lW)(null==m?void 0:m.address,v),D=P.balance,X=P.error,T=(0,E.Gp)(null==m?void 0:m.address,v,"0x5b31D8A0676Ae756BF9CF5591bB2a9E8aB65F925"),Y=T.allowance,z=T.isPending,K=T.error,O=(0,F.IJ)((null==m?void 0:m.address)||"",BigInt(s.head.id),v),V=O.verificationKeys,H=O.verificationInfos,W=O.isPending,G=O.error,L=(0,n._)((0,a.useState)(!1),2),q=L[0],Q=L[1],U=y.Ik({additionalStakeAmount:y.Yj().refine(e=>""===e.trim()||/^[0-9]+(?:,[0-9]{3})*(?:\.[0-9]+)?$/.test(e.trim()),{message:"请输入合法的数字格式"}).transform(e=>""===e.trim()?"0":e.trim().replace(/,/g,"")).refine(e=>"0"!==e,{message:"参与代币数不能为 0"}).refine(e=>{var r=(0,B.XS)(e);return o&&o>0n?null!==r&&r>0n:null!==r&&r>=BigInt(s.body.minStake)},{message:"参与代币数不能小于最小参与限制"}).refine(e=>{var r=(0,B.XS)(e);return null!==r&&void 0!==D&&r<=D},{message:"您的代币余额不足"}),verificationInfos:y.YO(y.Yj().min(1,{message:"验证信息不能为空"}))}),Z=s.body.verificationKeys.map(()=>""),ee=(0,j.mN)({resolver:(0,N.u)(U),defaultValues:{additionalStakeAmount:"",verificationInfos:Z},mode:"onChange"});(0,a.useEffect)(()=>{if(H&&H.length>0&&V){var e={};V.forEach((r,s)=>{e[r]=H[s]});var r=s.body.verificationKeys.map(r=>{var s;return null!=(s=e[r])?s:""});ee.setValue("verificationInfos",r)}},[H,V,ee,s.body.verificationKeys]);var er=(0,E.zH)(null==m?void 0:m.address),es=er.approve,en=er.isPending,et=er.isConfirming,ea=er.isConfirmed,ei=er.writeError,eo=(0,a.useRef)(null),el=(0,a.useRef)(z);(0,a.useEffect)(()=>{el.current&&!z&&eo.current&&eo.current.blur(),el.current=z},[z]),(0,a.useEffect)(()=>{ea&&(Q(!0),_.oR.success("授权".concat(null==m?void 0:m.symbol,"成功")))},[ea,null==m?void 0:m.symbol]);var ec=ee.watch("additionalStakeAmount"),ed=null!=(r=(0,B.XS)(ec||"0"))?r:0n;(0,a.useEffect)(()=>{ed>0n&&Y&&Y>0n&&Y>=ed?Q(!0):Q(!1)},[ed,z,Y]);var eu=(0,c.o9)(),em=eu.join,ef=eu.isPending,ex=eu.isConfirming,ev=eu.isConfirmed,eb=eu.writeError;(0,a.useEffect)(()=>{ev&&(_.oR.success("加入成功"),ee.reset(),setTimeout(()=>{l.push("/action/detail?id=".concat(s.head.id,"&type=join&symbol=").concat(null==m?void 0:m.symbol))},2e3))},[ev]);var eh=(0,d.g)().handleContractError;return((0,a.useEffect)(()=>{X&&eh(X,"token"),G&&eh(G,"join"),ei&&eh(ei,"token"),eb&&eh(eb,"join"),K&&eh(K,"token")},[X,G,ei,eb,K]),W)?(0,t.jsx)(x.A,{}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"px-6 pt-0 pb-2",children:[(0,t.jsx)($.A,{title:o?"增加参与代币":"参与行动"}),(0,t.jsx)(S.lV,(0,p._)((0,h._)({},ee),{children:(0,t.jsxs)("form",{onSubmit:e=>e.preventDefault(),className:"space-y-4",children:[(0,t.jsx)(S.zB,{control:ee.control,name:"additionalStakeAmount",render:e=>{var r=e.field;return(0,t.jsxs)(S.eI,{children:[(0,t.jsx)(S.lR,{className:"text-greyscale-500 font-normal",children:o?"":"参与代币数："}),(0,t.jsx)(S.MJ,{children:(0,t.jsx)(k.p,(0,h._)({placeholder:o?"最大可追加 ".concat((0,B.NJ)(D||0n)):"最小参与代币数 ".concat((0,B.NJ)(BigInt(s.body.minStake))),type:"number",disabled:!D||D<=0n,className:"!ring-secondary-foreground"},r))}),(0,t.jsx)(S.C5,{}),(0,t.jsxs)(S.Rr,{className:"flex items-center",children:[(0,t.jsxs)("span",{children:["共有 ",(0,t.jsx)("span",{className:"text-secondary",children:(0,B.NJ)(D||0n)})," ",null==m?void 0:m.symbol]}),(0,t.jsx)(w.$,{type:"button",variant:"link",size:"sm",onClick:()=>{D&&D>0n&&ee.setValue("additionalStakeAmount",(0,B.Js)(D))},className:"text-secondary p-0 ml-6",disabled:!D||D<=0n,children:"全部"})]})]})}}),s.body.verificationKeys.map((e,r)=>(0,t.jsx)(S.zB,{control:ee.control,name:"verificationInfos.".concat(r),render:n=>{var a=n.field;return(0,t.jsxs)(S.eI,{children:[(0,t.jsx)(S.lR,{className:"text-greyscale-500 font-normal",children:e}),(0,t.jsx)(S.MJ,{children:(0,t.jsx)(A.T,(0,h._)({placeholder:s.body.verificationInfoGuides[r]||"",className:"!ring-secondary-foreground"},a))}),(0,t.jsx)(S.C5,{})]})}},e+r)),(0,t.jsxs)("div",{className:"flex justify-center space-x-4 pt-2",children:[(0,t.jsx)(w.$,{ref:eo,className:"w-1/2",disabled:z||en||et||q,type:"button",onClick:()=>{ee.handleSubmit(e=>(0,b._)(function(){var r,s;return(0,g.YH)(this,function(n){switch(n.label){case 0:if(!(0,R.C)(J))return[2];if(0n===(s=null!=(r=(0,B.XS)(e.additionalStakeAmount))?r:0n)&&o&&o>0n)return _.oR.error("当前无需授权。"),[2];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,es("0x5b31D8A0676Ae756BF9CF5591bB2a9E8aB65F925",s)];case 2:return n.sent(),[3,4];case 3:return console.error("Approve failed",n.sent()),[3,4];case 4:return[2]}})})())()},children:z?(0,t.jsx)(C.A,{className:"animate-spin"}):en?"1.提交中...":et?"1.确认中...":q?"1.".concat(null==m?void 0:m.symbol,"已授权"):"1.授权".concat(null==m?void 0:m.symbol)}),(0,t.jsx)(w.$,{className:"w-1/2",disabled:!q||ef||ex||ev,type:"button",onClick:()=>{ee.handleSubmit(e=>(function(e){return(0,b._)(function(){var r,n,t;return(0,g.YH)(this,function(a){switch(a.label){case 0:if(!(0,R.C)(J))return[2];a.label=1;case 1:if(a.trys.push([1,3,,4]),r=!H||H.every(e=>!e||""===e.trim()),n=e.verificationInfos,!r&&H&&V)V.length===e.verificationInfos.length&&V.every((r,s)=>{var n=V.indexOf(r);return n>=0&&H[n]===e.verificationInfos[s]})&&(n=[]);else if(r&&e.verificationInfos.some(e=>!e||""===e.trim()))return _.oR.error("首次提交需要填写所有验证信息"),[2];return[4,em(null==m?void 0:m.address,BigInt(s.head.id),null!=(t=(0,B.XS)(e.additionalStakeAmount))?t:0n,n)];case 2:return a.sent(),[3,4];case 3:return console.error("Join failed",a.sent()),[3,4];case 4:return[2]}})})()})(e))()},children:ef?"2.提交中...":ex?"2.确认中...":ev?"2.已加入":"2.加入"})]})]})}))]}),(0,t.jsx)("div",{className:"px-6 pt-0 pb-4",children:(0,t.jsx)("div",{className:"text-greyscale-500 text-sm",children:"提示：加入行动后，可以随时取回参与代币，无等待期"})}),(0,t.jsx)(M.A,{isLoading:en||et||ef||ex,text:en||ef?"提交交易...":"确认交易..."})]})},P=()=>{var e=(0,i.useRouter)().query.id,r=(0,n._)((0,a.useState)(void 0),2),s=r[0],b=r[1],h=((0,a.useContext)(u.N)||{}).token,p=(0,c.vC)(),g=p.currentRound,N=p.isPending,j=p.error,y=(0,l.Y4)(null==h?void 0:h.address,void 0===e?void 0:BigInt(e)),I=y.actionInfo,_=y.isPending,w=y.error,C=(0,d.g)().handleContractError;return(0,a.useEffect)(()=>{j&&C(j,"join"),w&&C(w,"submit")},[j,w]),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(f.A,{title:"加入行动"}),(0,t.jsx)("main",{className:"flex-grow",children:!e||Array.isArray(e)||_||N?(0,t.jsx)(x.A,{}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(v.A,{actionId:BigInt(e),onRoundChange:()=>{},actionInfo:I,onStakedAmountChange:function(e){b(e)},showJoinButton:!1}),(0,t.jsx)(J,{actionInfo:I,stakedAmount:s}),(0,t.jsx)("div",{className:"flex flex-col w-full p-4",children:(0,t.jsxs)("div",{className:"bg-blue-50/30 border-l-4 border-l-blue-50 rounded-r-lg p-4 mb-8 text-sm",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 text-base font-bold text-blue-800 pb-2",children:[(0,t.jsx)(o.A,{className:"w-4 h-4"}),"提示"]}),(0,t.jsx)("div",{className:"text-base font-bold text-blue-700 pt-2 pb-1",children:"行动激励："}),(0,t.jsx)("div",{className:"text-sm text-blue-700",children:"1、验证阶段会随机抽取地址验证打分，然后按得分比例给这些地址分配代币激励"}),(0,t.jsx)("div",{className:"text-sm text-blue-700",children:"2、只有当1个行动获得的验证票数，达到该轮总投票数5%时，参与该行动才有激励"}),(0,t.jsx)("div",{className:"text-base font-bold text-blue-700 pt-2 pb-1",children:"参与代币："}),(0,t.jsx)("div",{className:"text-sm text-blue-700",children:"1、参与代币越多，被选中验证并获得奖励的概率越大"}),(0,t.jsx)("div",{className:"text-sm text-blue-700",children:"2、参与的代币可随时取回，如不取回则自动参与此行动的后续轮次"})]})}),(0,t.jsx)(m.A,{actionId:BigInt(e),round:g,showSubmitter:!1})]})})]})}},33676:(e,r,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/acting/join",function(){return s(28529)}])},40150:(e,r,s)=>{"use strict";s.d(r,{T:()=>l});var n=s(3576),t=s(65699),a=s(37876),i=s(14232),o=s(30684),l=i.forwardRef((e,r)=>{var s=e.className,i=(0,t._)(e,["className"]);return(0,a.jsx)("textarea",(0,n._)({className:(0,o.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:r},i))});l.displayName="Textarea"},42038:(e,r,s)=>{"use strict";s.d(r,{C:()=>t});var n=s(97685),t=e=>{if(!e)return n.oR.error("请先将钱包链接 ".concat("Thinkium Mainnet Chain 1")),!1;return!0}},62212:(e,r,s)=>{"use strict";s.d(r,{A:()=>n});var n=(0,s(11713).A)("CircleHelp",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},92659:(e,r,s)=>{"use strict";s.d(r,{lV:()=>b,MJ:()=>I,Rr:()=>_,zB:()=>p,eI:()=>j,lR:()=>y,C5:()=>w});var n=s(81110),t=s(40120),a=s(3576),i=s(62701),o=s(65699),l=s(37876),c=s(14232),d=s(82987),u=s(88992),m=s(30684),f=s(59773),x=(0,s(47137).F)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),v=c.forwardRef((e,r)=>{var s=e.className,n=(0,o._)(e,["className"]);return(0,l.jsx)(f.b,(0,a._)({ref:r,className:(0,m.cn)(x(),s)},n))});v.displayName=f.b.displayName;var b=u.Op,h=c.createContext({}),p=e=>{var r=(0,n._)({},(0,t._)(e));return(0,l.jsx)(h.Provider,{value:{name:r.name},children:(0,l.jsx)(u.xI,(0,a._)({},r))})},g=()=>{var e=c.useContext(h),r=c.useContext(N),s=(0,u.xW)(),n=s.getFieldState,t=s.formState,i=n(e.name,t);if(!e)throw Error("useFormField should be used within <FormField>");var o=r.id;return(0,a._)({id:o,name:e.name,formItemId:"".concat(o,"-form-item"),formDescriptionId:"".concat(o,"-form-item-description"),formMessageId:"".concat(o,"-form-item-message")},i)},N=c.createContext({}),j=c.forwardRef((e,r)=>{var s=e.className,n=(0,o._)(e,["className"]),t=c.useId();return(0,l.jsx)(N.Provider,{value:{id:t},children:(0,l.jsx)("div",(0,a._)({ref:r,className:(0,m.cn)("space-y-2",s)},n))})});j.displayName="FormItem";var y=c.forwardRef((e,r)=>{var s=e.className,n=(0,o._)(e,["className"]),t=g(),i=t.error,c=t.formItemId;return(0,l.jsx)(v,(0,a._)({ref:r,className:(0,m.cn)(i&&"text-destructive",s),htmlFor:c},n))});y.displayName="FormLabel";var I=c.forwardRef((e,r)=>{var s=(0,n._)({},(0,t._)(e)),i=g(),o=i.error,c=i.formItemId,u=i.formDescriptionId,m=i.formMessageId;return(0,l.jsx)(d.DX,(0,a._)({ref:r,id:c,"aria-describedby":o?"".concat(u," ").concat(m):"".concat(u),"aria-invalid":!!o},s))});I.displayName="FormControl";var _=c.forwardRef((e,r)=>{var s=e.className,n=(0,o._)(e,["className"]),t=g().formDescriptionId;return(0,l.jsx)("p",(0,a._)({ref:r,id:t,className:(0,m.cn)("text-sm text-muted-foreground",s)},n))});_.displayName="FormDescription";var w=c.forwardRef((e,r)=>{var s=e.className,n=e.children,t=(0,o._)(e,["className","children"]),c=g(),d=c.error,u=c.formMessageId,f=d?String(null==d?void 0:d.message):n;return f?(0,l.jsx)("p",(0,i._)((0,a._)({ref:r,id:u,className:(0,m.cn)("text-sm font-medium text-destructive",s)},t),{children:f})):null});w.displayName="FormMessage"}},e=>{e.O(0,[3308,7460,8230,9985,154,3096,4769,5139,4115,7432,1217,636,6593,8792],()=>e(e.s=33676)),_N_E=e.O()}]);