(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9063],{18449:(e,r,n)=>{"use strict";n.d(r,{X:()=>a});var s=n(76200);class t extends s.C{constructor({value:e}){super(`Number \`${e}\` is not a valid decimal number.`,{name:"InvalidDecimalNumberError"})}}function a(e,r){if(!/^(-?)([0-9]*)\.?([0-9]*)$/.test(e))throw new t({value:e});let[n,s="0"]=e.split("."),a=n.startsWith("-");if(a&&(n=n.slice(1)),s=s.replace(/(0+)$/,""),0===r)1===Math.round(Number(`.${s}`))&&(n=`${BigInt(n)+1n}`),s="";else if(s.length>r){let[e,t,a]=[s.slice(0,r-1),s.slice(r-1,r),s.slice(r)],i=Math.round(Number(`${t}.${a}`));(s=i>9?`${BigInt(e)+BigInt(1)}0`.padStart(e.length+1,"0"):`${e}${i}`).length>r&&(s=s.slice(1),n=`${BigInt(n)+1n}`),s=s.slice(0,r)}else s=s.padEnd(r,"0");return BigInt(`${a?"-":""}${n}${s}`)}},28529:(e,r,n)=>{"use strict";n.r(r),n.d(r,{default:()=>J});var s=n(40854),t=n(37876),a=n(14232),i=n(89099),o=n(62212),l=n(64115),c=n(17660),d=n(4113),u=n(20442),m=n(83416),f=n(92101),v=n(60154),x=n(12293),b=n(22605),N=n(16927),h=n(3576),p=n(62701),g=n(4902),j=n(13810),I=n(88992),_=n(22442),y=n(8047),C=n(1081),A=n(97685),w=n(6960),E=n(7446),k=n(77932),R=n(40150),S=n(92659),B=n(42038),T=n(9215),$=n(44769),F=n(1709),P=n(99574),X=n(99742);let D=e=>{var r,n=e.actionInfo,o=e.stakedAmount,l=(0,i.useRouter)(),f=((0,a.useContext)(m.N)||{}).token,v=(0,y.F)().address,b=(0,C.i)(),D=(0,T.lW)(null==f?void 0:f.address,v),M=D.balance,J=D.error,O=(0,T.Gp)(null==f?void 0:f.address,v,X.env.NEXT_PUBLIC_CONTRACT_ADDRESS_JOIN),z=O.allowance,H=O.isPending,L=O.error,U=(0,$.IJ)((null==f?void 0:f.address)||"",BigInt(n.head.id),v),V=U.verificationKeys,Y=U.verificationInfos,K=U.isPending,W=U.error,G=(0,s._)((0,a.useState)(!1),2),q=G[0],Q=G[1],Z=_.Ik({additionalStakeAmount:_.Yj().refine(e=>""===e.trim()||/^[0-9]+(?:,[0-9]{3})*(?:\.[0-9]+)?$/.test(e.trim()),{message:"请输入合法的数字格式"}).transform(e=>""===e.trim()?"0":e.trim().replace(/,/g,"")).refine(e=>"0"!==e,{message:"参与代币数不能为 0"}).refine(e=>{var r=(0,u.XS)(e);return o&&o>0n?null!==r&&r>0n:null!==r&&r>=BigInt(n.body.minStake)},{message:"参与代币数不能小于最小参与限制"}).refine(e=>{var r=(0,u.XS)(e);return null!==r&&void 0!==M&&r<=M},{message:"您的代币余额不足"}),verificationInfos:_.YO(_.Yj().min(1,{message:"验证信息不能为空"}))}),ee=n.body.verificationKeys.map(()=>""),er=(0,I.mN)({resolver:(0,j.u)(Z),defaultValues:{additionalStakeAmount:"",verificationInfos:ee},mode:"onChange"});(0,a.useEffect)(()=>{if(Y&&Y.length>0&&V){var e={};V.forEach((r,n)=>{e[r]=Y[n]});var r=n.body.verificationKeys.map(r=>{var n;return null!=(n=e[r])?n:""});er.setValue("verificationInfos",r)}},[Y,V,er,n.body.verificationKeys]);var en=(0,T.zH)(null==f?void 0:f.address),es=en.approve,et=en.isPending,ea=en.isConfirming,ei=en.isConfirmed,eo=en.writeError,el=(0,a.useRef)(null),ec=(0,a.useRef)(H);(0,a.useEffect)(()=>{ec.current&&!H&&el.current&&el.current.blur(),ec.current=H},[H]),(0,a.useEffect)(()=>{ei&&(Q(!0),A.oR.success("授权".concat(null==f?void 0:f.symbol,"成功")))},[ei,null==f?void 0:f.symbol]);var ed=er.watch("additionalStakeAmount"),eu=null!=(r=(0,u.XS)(ed||"0"))?r:0n;(0,a.useEffect)(()=>{eu>0n&&z&&z>0n&&z>=eu?Q(!0):Q(!1)},[eu,H,z]);var em=(0,c.o9)(),ef=em.join,ev=em.isPending,ex=em.isConfirming,eb=em.isConfirmed,eN=em.writeError;(0,a.useEffect)(()=>{eb&&(A.oR.success("加入成功"),er.reset(),setTimeout(()=>{l.push("/action/detail?id=".concat(n.head.id,"&type=join&symbol=").concat(null==f?void 0:f.symbol))},2e3))},[eb]);var eh=(0,d.g)().handleContractError;return((0,a.useEffect)(()=>{J&&eh(J,"token"),W&&eh(W,"join"),eo&&eh(eo,"token"),eN&&eh(eN,"join"),L&&eh(L,"token")},[J,W,eo,eN,L]),K)?(0,t.jsx)(x.A,{}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"px-6 pt-0 pb-2",children:[(0,t.jsx)(F.A,{title:o?"增加参与代币":"参与行动"}),(0,t.jsx)(S.lV,(0,p._)((0,h._)({},er),{children:(0,t.jsxs)("form",{onSubmit:e=>e.preventDefault(),className:"space-y-4",children:[(0,t.jsx)(S.zB,{control:er.control,name:"additionalStakeAmount",render:e=>{var r=e.field;return(0,t.jsxs)(S.eI,{children:[(0,t.jsx)(S.lR,{className:"text-greyscale-500 font-normal",children:o?"":"参与代币数："}),(0,t.jsx)(S.MJ,{children:(0,t.jsx)(k.p,(0,h._)({placeholder:o?"最大可追加 ".concat((0,u.NJ)(M||0n)):"最小参与代币数 ".concat((0,u.NJ)(BigInt(n.body.minStake))),type:"number",disabled:!M||M<=0n,className:"!ring-secondary-foreground"},r))}),(0,t.jsx)(S.C5,{}),(0,t.jsxs)(S.Rr,{className:"flex items-center",children:[(0,t.jsxs)("span",{children:["共有 ",(0,t.jsx)("span",{className:"text-secondary",children:(0,u.NJ)(M||0n)})," ",null==f?void 0:f.symbol]}),(0,t.jsx)(w.$,{type:"button",variant:"link",size:"sm",onClick:()=>{M&&M>0n&&er.setValue("additionalStakeAmount",(0,u.Js)(M))},className:"text-secondary p-0 ml-6",disabled:!M||M<=0n,children:"全部"})]})]})}}),n.body.verificationKeys.map((e,r)=>(0,t.jsx)(S.zB,{control:er.control,name:"verificationInfos.".concat(r),render:s=>{var a=s.field;return(0,t.jsxs)(S.eI,{children:[(0,t.jsx)(S.lR,{className:"text-greyscale-500 font-normal",children:e}),(0,t.jsx)(S.MJ,{children:(0,t.jsx)(R.T,(0,h._)({placeholder:n.body.verificationInfoGuides[r]||"",className:"!ring-secondary-foreground"},a))}),(0,t.jsx)(S.C5,{})]})}},e+r)),(0,t.jsxs)("div",{className:"flex justify-center space-x-4 pt-2",children:[(0,t.jsx)(w.$,{ref:el,className:"w-1/2",disabled:H||et||ea||q,type:"button",onClick:()=>{er.handleSubmit(e=>(0,N._)(function(){var r,n;return(0,g.YH)(this,function(s){switch(s.label){case 0:if(!(0,B.z)(b))return[2];if(0n===(n=null!=(r=(0,u.XS)(e.additionalStakeAmount))?r:0n)&&o&&o>0n)return A.oR.error("当前无需授权。"),[2];s.label=1;case 1:return s.trys.push([1,3,,4]),[4,es(X.env.NEXT_PUBLIC_CONTRACT_ADDRESS_JOIN,n)];case 2:return s.sent(),[3,4];case 3:return console.error("Approve failed",s.sent()),[3,4];case 4:return[2]}})})())()},children:H?(0,t.jsx)(E.A,{className:"animate-spin"}):et?"1.提交中...":ea?"1.确认中...":q?"1.".concat(null==f?void 0:f.symbol,"已授权"):"1.授权".concat(null==f?void 0:f.symbol)}),(0,t.jsx)(w.$,{className:"w-1/2",disabled:!q||ev||ex||eb,type:"button",onClick:()=>{er.handleSubmit(e=>(function(e){return(0,N._)(function(){var r,s,t;return(0,g.YH)(this,function(a){switch(a.label){case 0:if(!(0,B.z)(b))return[2];a.label=1;case 1:if(a.trys.push([1,3,,4]),r=!Y||Y.every(e=>!e||""===e.trim()),s=e.verificationInfos,!r&&Y&&V)V.length===e.verificationInfos.length&&V.every((r,n)=>{var s=V.indexOf(r);return s>=0&&Y[s]===e.verificationInfos[n]})&&(s=[]);else if(r&&e.verificationInfos.some(e=>!e||""===e.trim()))return A.oR.error("首次提交需要填写所有验证信息"),[2];return[4,ef(null==f?void 0:f.address,BigInt(n.head.id),null!=(t=(0,u.XS)(e.additionalStakeAmount))?t:0n,s)];case 2:return a.sent(),[3,4];case 3:return console.error("Join failed",a.sent()),[3,4];case 4:return[2]}})})()})(e))()},children:ev?"2.提交中...":ex?"2.确认中...":eb?"2.已加入":"2.加入"})]})]})}))]}),(0,t.jsx)("div",{className:"px-6 pt-0 pb-4",children:(0,t.jsx)("div",{className:"text-greyscale-500 text-sm",children:"提示：加入行动后，可以随时取回参与代币，无等待期"})}),(0,t.jsx)(P.A,{isLoading:et||ea||ev||ex,text:et||ev?"提交交易...":"确认交易..."})]})};var M=n(99742);let J=()=>{var e=(0,i.useRouter)().query.id,r=(0,s._)((0,a.useState)(void 0),2),n=r[0],N=r[1],h=((0,a.useContext)(m.N)||{}).token,p=(0,c.vC)(),g=p.currentRound,j=p.isPending,I=p.error,_=(0,l.Y4)(null==h?void 0:h.address,void 0===e?void 0:BigInt(e)),y=_.actionInfo,C=_.isPending,A=_.error,w=(0,d.g)().handleContractError;return(0,a.useEffect)(()=>{I&&w(I,"join"),A&&w(A,"submit")},[I,A]),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(v.A,{title:"加入行动",showBackButton:!0}),(0,t.jsx)("main",{className:"flex-grow",children:!e||Array.isArray(e)||C||j?(0,t.jsx)(x.A,{}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(b.A,{actionId:BigInt(e),onRoundChange:()=>{},actionInfo:y,onStakedAmountChange:function(e){N(e)},showJoinButton:!1}),(0,t.jsx)(D,{actionInfo:y,stakedAmount:n}),(0,t.jsx)("div",{className:"flex flex-col w-full p-4",children:(0,t.jsxs)("div",{className:"bg-blue-50/30 border-l-4 border-l-blue-50 rounded-r-lg p-4 mb-8 text-sm",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 text-base font-bold text-blue-800 pb-2",children:[(0,t.jsx)(o.A,{className:"w-4 h-4"}),"提示"]}),(0,t.jsx)("div",{className:"text-base font-bold text-blue-700 pt-2 pb-1",children:"行动激励："}),(0,t.jsx)("div",{className:"text-sm text-blue-700",children:"1、验证阶段会随机抽取地址验证打分，然后按得分比例给这些地址分配代币激励"}),(0,t.jsxs)("div",{className:"text-sm text-blue-700",children:["2、只有当1个行动获得的验证票数，达到该轮总投票数",(0,u.Ee)(Number(M.env.NEXT_PUBLIC_ACTION_REWARD_MIN_VOTE_PER_THOUSAND)/10),"时，参与该行动才有激励"]}),(0,t.jsx)("div",{className:"text-base font-bold text-blue-700 pt-2 pb-1",children:"参与代币："}),(0,t.jsx)("div",{className:"text-sm text-blue-700",children:"1、参与代币越多，被选中验证并获得奖励的概率越大"}),(0,t.jsx)("div",{className:"text-sm text-blue-700",children:"2、参与的代币可随时取回，如不取回则自动参与此行动的后续轮次"})]})}),(0,t.jsx)(f.A,{actionId:BigInt(e),round:g,showSubmitter:!1})]})})]})}},33676:(e,r,n)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/acting/join",function(){return n(28529)}])},40150:(e,r,n)=>{"use strict";n.d(r,{T:()=>l});var s=n(3576),t=n(65699),a=n(37876),i=n(14232),o=n(30684),l=i.forwardRef((e,r)=>{var n=e.className,i=(0,t._)(e,["className"]);return(0,a.jsx)("textarea",(0,s._)({className:(0,o.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",n),ref:r},i))});l.displayName="Textarea"},42038:(e,r,n)=>{"use strict";n.d(r,{z:()=>i});var s=n(97685),t=n(99090),a=n(99742),i=e=>{var r,n=(()=>{var e,r,n=null==(r=t.$.chains)||null==(e=r[0])?void 0:e.id;if("number"==typeof n)return n;var s=Number(a.env.NEXT_PUBLIC_CHAIN_ID);return Number.isFinite(s)?s:void 0})();return!!e&&!!n&&e===n||(s.oR.error("请先将钱包链接 ".concat(null!=(r=a.env.NEXT_PUBLIC_CHAIN_NAME)?r:a.env.NEXT_PUBLIC_CHAIN)),!1)}},62212:(e,r,n)=>{"use strict";n.d(r,{A:()=>s});var s=(0,n(11713).A)("CircleHelp",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},92659:(e,r,n)=>{"use strict";n.d(r,{lV:()=>b,MJ:()=>_,Rr:()=>y,zB:()=>h,eI:()=>j,lR:()=>I,C5:()=>C});var s=n(81110),t=n(40120),a=n(3576),i=n(62701),o=n(65699),l=n(37876),c=n(14232),d=n(82987),u=n(88992),m=n(30684),f=n(59773),v=(0,n(47137).F)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),x=c.forwardRef((e,r)=>{var n=e.className,s=(0,o._)(e,["className"]);return(0,l.jsx)(f.b,(0,a._)({ref:r,className:(0,m.cn)(v(),n)},s))});x.displayName=f.b.displayName;var b=u.Op,N=c.createContext({}),h=e=>{var r=(0,s._)({},(0,t._)(e));return(0,l.jsx)(N.Provider,{value:{name:r.name},children:(0,l.jsx)(u.xI,(0,a._)({},r))})},p=()=>{var e=c.useContext(N),r=c.useContext(g),n=(0,u.xW)(),s=n.getFieldState,t=n.formState,i=s(e.name,t);if(!e)throw Error("useFormField should be used within <FormField>");var o=r.id;return(0,a._)({id:o,name:e.name,formItemId:"".concat(o,"-form-item"),formDescriptionId:"".concat(o,"-form-item-description"),formMessageId:"".concat(o,"-form-item-message")},i)},g=c.createContext({}),j=c.forwardRef((e,r)=>{var n=e.className,s=(0,o._)(e,["className"]),t=c.useId();return(0,l.jsx)(g.Provider,{value:{id:t},children:(0,l.jsx)("div",(0,a._)({ref:r,className:(0,m.cn)("space-y-2",n)},s))})});j.displayName="FormItem";var I=c.forwardRef((e,r)=>{var n=e.className,s=(0,o._)(e,["className"]),t=p(),i=t.error,c=t.formItemId;return(0,l.jsx)(x,(0,a._)({ref:r,className:(0,m.cn)(i&&"text-destructive",n),htmlFor:c},s))});I.displayName="FormLabel";var _=c.forwardRef((e,r)=>{var n=(0,s._)({},(0,t._)(e)),i=p(),o=i.error,c=i.formItemId,u=i.formDescriptionId,m=i.formMessageId;return(0,l.jsx)(d.DX,(0,a._)({ref:r,id:c,"aria-describedby":o?"".concat(u," ").concat(m):"".concat(u),"aria-invalid":!!o},n))});_.displayName="FormControl";var y=c.forwardRef((e,r)=>{var n=e.className,s=(0,o._)(e,["className"]),t=p().formDescriptionId;return(0,l.jsx)("p",(0,a._)({ref:r,id:t,className:(0,m.cn)("text-sm text-muted-foreground",n)},s))});y.displayName="FormDescription";var C=c.forwardRef((e,r)=>{var n=e.className,s=e.children,t=(0,o._)(e,["className","children"]),c=p(),d=c.error,u=c.formMessageId,f=d?String(null==d?void 0:d.message):s;return f?(0,l.jsx)("p",(0,i._)((0,a._)({ref:r,id:u,className:(0,m.cn)("text-sm font-medium text-destructive",n)},t),{children:f})):null});C.displayName="FormMessage"}},e=>{e.O(0,[3308,4243,9985,154,5498,4769,5139,4115,7432,1217,636,6593,8792],()=>e(e.s=33676)),_N_E=e.O()}]);